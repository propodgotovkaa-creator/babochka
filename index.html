<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</title>

<style>
:root{
  --bg:#0b1020;
  --panel:rgba(20,24,40,.82);
  --line:rgba(255,255,255,.14);
  --txt:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.65);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui;background:var(--bg);color:var(--txt)}

.wrap{display:grid;grid-template-columns:360px 1fr;height:100%}

.panel{
  background:var(--panel);
  border-right:1px solid var(--line);
  padding:14px;
  overflow:auto;
}

.panel h1{font-size:16px;margin:0 0 12px}

.row{margin:10px 0}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

input,select,textarea{
  width:100%;padding:10px;border-radius:10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--txt);
}

input[type=range]{padding:0}
textarea{resize:vertical;min-height:70px}

.two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

button{
  border:0;border-radius:10px;
  padding:10px 12px;
  font-weight:700;
  cursor:pointer;
}
.b1{background:#2d6cdf;color:#fff}
.b2{background:#16a34a;color:#fff}
.b3{background:rgba(255,255,255,.12);color:#fff;border:1px solid var(--line)}

.stage{
  position:relative;
  overflow:hidden;
  background:
    linear-gradient(0deg,rgba(255,255,255,.04),rgba(255,255,255,.04)),
    repeating-linear-gradient(45deg,rgba(255,255,255,.035) 0 12px,rgba(255,255,255,.02) 12px 24px);
}

.centerTask{
  position:absolute;
  left:50%;top:18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.45);
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  font-weight:700;
  z-index:20;
  pointer-events:none;
}

.progBadge{
  position:absolute;
  right:14px;top:14px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.18);
  font-size:12px;
  z-index:20;
  pointer-events:none;
}

.hintBtn{
  position:absolute;
  right:64px;top:12px;
  width:38px;height:38px;
  border-radius:12px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);
  font-size:18px;
  cursor:pointer;
  z-index:21;
}

.target{
  position:absolute;
  cursor:pointer;
  z-index:10;
}
.target img{width:100%;height:100%;object-fit:contain}

@keyframes hintPulse{
  0%{transform:scale(1);opacity:1}
  50%{transform:scale(1.25);opacity:.4}
  100%{transform:scale(1);opacity:1}
}
.target.hint img{animation:hintPulse .9s ease-in-out 2}

.final{
  position:absolute;inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.3);
  z-index:30;
}
.finalCard{
  background:rgba(0,0,0,.6);
  padding:18px;
  border-radius:18px;
  font-size:18px;
  font-weight:800;
}
</style>
</head>

<body>
<div class="wrap">

<div class="panel">
<h1>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</h1>

<div class="row">
<label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏</label>
<input id="imgUrl">
</div>

<div class="row">
<label>–†–∞–∑–º–µ—Ä: <span id="sizeVal">46</span> px</label>
<input id="size" type="range" min="20" max="200" value="46">
</div>

<div class="row">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–æ–∫</label>
<input id="rounds" type="number" value="7">
</div>

<div class="row">
<label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</label>
<input id="taskText" value="–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!">
</div>

<div class="row">
<label>–¢–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ</label>
<textarea id="endText">–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∏—Ö–æ–¥–∏ –∏–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ üòä</textarea>
</div>

<div class="row two">
<button class="b3" id="reset">–°–±—Ä–æ—Å</button>
<button class="b1" id="getCode">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
</div>

<div class="row">
<textarea id="code" style="height:220px"></textarea>
</div>
</div>

<div class="stage" id="stage">
<div class="centerTask" id="centerTask"></div>
<div class="progBadge" id="prog"></div>
<button class="hintBtn" id="hint">üí°</button>

<div class="target" id="target">
<img id="img">
</div>

<div class="final" id="final">
<div class="finalCard" id="finalText"></div>
</div>
</div>

</div>

<script>
const $=id=>document.getElementById(id);

const DEFAULT_URL="https://propodgotovkaa-creator.github.io/babochka/babochka.png";

const imgUrl=$("imgUrl"), size=$("size"), sizeVal=$("sizeVal"),
rounds=$("rounds"), taskText=$("taskText"), endText=$("endText"),
stage=$("stage"), target=$("target"), img=$("img"),
prog=$("prog"), hint=$("hint"),
final=$("final"), finalText=$("finalText"), code=$("code");

let found=0,last=null,history=[];

function rect(){
  const r=stage.getBoundingClientRect();
  return {w:r.width,h:r.height};
}

function forbidden(){
  const {w,h}=rect();
  return [
    {x:0,y:h-80,w:200,h:80},            // logo
    {x:w-100,y:0,w:100,h:h},            // next arrow
    {x:w/2-200,y:0,w:400,h:80}           // instruction
  ];
}

function intersects(a,b){
  return !(a.x+a.w<b.x||b.x+b.w<a.x||a.y+a.h<b.y||b.y+b.h<a.y);
}

function randomPos(){
  const {w,h}=rect();
  const s=+size.value;
  let best=null,score=-1;
  for(let i=0;i<60;i++){
    const p={x:Math.random()*(w-s),y:Math.random()*(h-s)};
    const r={x:p.x,y:p.y,w:s,h:s};
    if(forbidden().some(f=>intersects(r,f))) continue;
    let d=last?Math.hypot(p.x-last.x,p.y-last.y):999;
    let hmin=Math.min(...history.map(o=>Math.hypot(p.x-o.x,p.y-o.y)).concat([999]));
    let sc=d+hmin;
    if(sc>score){score=sc;best=p;}
  }
  last=best;history.push(best);if(history.length>8)history.shift();
  return best||{x:20,y:100};
}

function place(){
  const p=randomPos();
  target.style.left=p.x+"px";
  target.style.top=p.y+"px";
}

function update(){
  sizeVal.textContent=size.value;
  target.style.width=size.value+"px";
  target.style.height=size.value+"px";
  $("centerTask").textContent=taskText.value;
  prog.textContent=`${found}/${rounds.value}`;
  finalText.textContent=endText.value;
}

function next(){
  if(found>=+rounds.value){final.style.display="flex";return;}
  place();
}

target.onclick=()=>{
  found++;
  update();
  setTimeout(next,200);
};

hint.onclick=()=>{
  target.classList.add("hint");
  setTimeout(()=>target.classList.remove("hint"),1800);
};

$("reset").onclick=()=>{
  found=0;history=[];last=null;
  final.style.display="none";
  update();
  next();
};

size.oninput=()=>{
  update();
  place();
};

imgUrl.onchange=()=>img.src=imgUrl.value;

img.src=imgUrl.value=DEFAULT_URL;
update();
next();
</script>
</body>
</html>
